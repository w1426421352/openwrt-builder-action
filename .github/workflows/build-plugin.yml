name: Build OpenWrt Plugin

on:
  workflow_dispatch:  # 手动触发，用户无需输入内容

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # Checkout OpenWrt repository
      - name: Checkout OpenWrt repository
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      # Read config.json to get OpenWrt version and plugin repository URL
      - name: Read config.json
        id: config
        run: |
          echo "Reading config.json"
          OPENWRT_VERSION=$(jq -r .openwrt_version config.json)
          PLUGIN_REPO=$(jq -r .plugin_repo config.json)
          echo "OpenWrt Version: $OPENWRT_VERSION"
          echo "Plugin Repo: $PLUGIN_REPO"
          echo "OPENWRT_VERSION=${OPENWRT_VERSION}" >> $GITHUB_ENV
          echo "PLUGIN_REPO=${PLUGIN_REPO}" >> $GITHUB_ENV

      # Build the OpenWrt package using the SDK
      - name: Build OpenWrt Plugin
        uses: openwrt/gh-action-sdk@main
        env:
          ARCH: x86_64  # Change as per your target architecture (e.g., x86_64, mips_24kc)
          OPENWRT_VERSION: ${{ env.OPENWRT_VERSION }}  # Use version from config.json
          EXTRA_FEEDS: ${{ env.PLUGIN_REPO }}  # Add the plugin repository URL to feeds.conf

      # Upload the compiled plugin as an artifact
      - name: Upload plugin artifact
        uses: actions/upload-artifact@v4
        with:
          name: plugin-ipk
          path: bin/packages/*/*.ipk
